<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ðŸ’€ Religious & Spiritual Talking â€” Friends</title>
<meta name="theme-color" content="#000" />
<style>
:root{--bg:#050506;--card:#0f1112;--muted:#9aa0a6;--ink:#e6eef2;--line:#1f2326;--accent:#7dd3fc;--accent2:#a78bfa}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#000);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.app{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
.top{display:flex;align-items:center;gap:12px;padding:12px}
.logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041017;font-weight:900}
.title{font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}
.container{flex:1;padding:10px;display:flex;flex-direction:column;gap:10px}
.card{background:var(--card);border-radius:14px;padding:10px;border:1px solid var(--line);display:flex;flex-direction:column;gap:8px}
.groups{display:flex;flex-direction:column;gap:8px;overflow:auto}
.group{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer}
.row{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#041017;padding:8px 10px;border-radius:10px;cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.chatShell{display:flex;flex-direction:column;height:62vh;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
.chatHeader{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--line)}
.msgList{flex:1;padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.bubble{max-width:78%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--line)}
.mine{margin-left:auto;background:linear-gradient(180deg,#0b1220,#0f1b2a)}
.msgMeta{font-size:11px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center}
.chatFooter{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--ink);outline:none}
.hidden{display:none}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:#0b1220;color:#fff;padding:8px 12px;border-radius:10px;z-index:999}
.adminBox{padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--line)}
.menuBtn{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:transparent;color:var(--ink);cursor:pointer}
.danger{color:#ef4444}
@media (max-width:420px){ .app{padding:6px} .chatShell{height:58vh} }
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="top">
      <div class="logo">ðŸ’¬</div>
      <div style="flex:1">
        <div class="title">Religious & Spiritual Talking</div>
        <div class="subtitle" id="subtitle">Friends-only chat â€¢ mobile-focused</div>
      </div>
      <div id="authArea" class="row">
        <button id="signInBtn" class="btn">Sign in with Google</button>
        <button id="signOutBtn" class="btn hidden">Sign out</button>
      </div>
    </div>

    <div class="container">
      <!-- Home: groups list -->
      <div id="home" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Groups</div>
            <div class="small">General is public â€” everyone can send</div>
          </div>
          <div class="row">
            <button id="zoomOut" class="menuBtn">âˆ’</button>
            <div id="zoomLabel" class="small">100%</div>
            <button id="zoomIn" class="menuBtn">ï¼‹</button>
          </div>
        </div>

        <div id="groupsList" class="groups" style="margin-top:8px"></div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button id="createGroupBtn" class="btn">+ Create group</button>
          <button id="adminPanelBtn" class="btn hidden">Admin</button>
        </div>

        <div id="createNote" class="small">Admins can create up to 3 groups (private). Use admin button to manage members.</div>
      </div>

      <!-- Chat shell -->
      <div id="chatCard" class="chatShell hidden">
        <div class="chatHeader">
          <div>
            <div id="roomTitle" style="font-weight:800">Group</div>
            <div class="small" id="roomSubtitle">Private / Public</div>
          </div>
          <div class="row">
            <div id="meName" class="small">Not signed</div>
            <button id="leaveBtn" class="menuBtn">Leave</button>
          </div>
        </div>

        <div id="msgList" class="msgList"></div>

        <div class="chatFooter">
          <input id="msgInput" class="input" placeholder="Type a messageâ€¦" />
          <button id="sendBtn" class="btn">Send</button>
        </div>
      </div>

      <!-- Admin panel modal area -->
      <div id="adminPanel" class="card hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Admin Controls</div>
          <div class="small">You are admin</div>
        </div>

        <div class="adminBox">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="newGroupName" class="input" placeholder="New group name (private)" />
            <button id="doCreateGroup" class="btn">Create</button>
          </div>

          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <input id="memberEmail" class="input" placeholder="Add member by email (to selected group)" />
            <button id="addMemberBtn" class="btn">Add</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="banBtn" class="menuBtn">ðŸš« Ban user</button>
            <button id="clearGroupBtn" class="menuBtn danger">ðŸ§¹ Clear messages</button>
          </div>

          <div style="margin-top:10px">
            <div class="small">Admins list (manage in console) â€” changes reflect here:</div>
            <div id="adminsList" class="small"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="toastWrap"></div>

<script type="module">
// --- Firebase modular imports ---
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

// ---------- Your Firebase config (from your project messages-30e3a) ----------
const firebaseConfig = {
  apiKey: "AIzaSyCRYqtAQifwmFqbnb5PZy2SVI-cSOfshVc",
  authDomain: "messages-30e3a.firebaseapp.com",
  projectId: "messages-30e3a",
  storageBucket: "messages-30e3a.appspot.com",
  messagingSenderId: "131390317978",
  appId: "1:131390317978:web:8c05070328b5bcbf49c623"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// ---------- UI refs ----------
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const subtitle = document.getElementById('subtitle');
const groupsList = document.getElementById('groupsList');
const createGroupBtn = document.getElementById('createGroupBtn');
const adminPanelBtn = document.getElementById('adminPanelBtn');
const chatCard = document.getElementById('chatCard');
const roomTitle = document.getElementById('roomTitle');
const roomSubtitle = document.getElementById('roomSubtitle');
const meName = document.getElementById('meName');
const msgList = document.getElementById('msgList');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const leaveBtn = document.getElementById('leaveBtn');
const adminPanel = document.getElementById('adminPanel');
const doCreateGroup = document.getElementById('doCreateGroup');
const newGroupName = document.getElementById('newGroupName');
const addMemberBtn = document.getElementById('addMemberBtn');
const memberEmail = document.getElementById('memberEmail');
const adminsList = document.getElementById('adminsList');
const banBtn = document.getElementById('banBtn');
const clearGroupBtn = document.getElementById('clearGroupBtn');
const zoomIn = document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomLabel = document.getElementById('zoomLabel');

let me = null;
let currentGroup = null;
let messagesUnsub = null;
let isAdmin = false;
let CONFIG_ADMIN = { password: null, maxGroups: 3, defaultGroup: 'general' };
let zoom = Number(localStorage.getItem('zoom')||1);

// ---------- helpers ----------
function toast(t){ const el=document.createElement('div'); el.className='toast'; el.textContent=t; document.body.appendChild(el); setTimeout(()=>el.style.opacity='0',2200); setTimeout(()=>el.remove(),2600); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function applyZoom(){ zoom=Math.min(1.6,Math.max(0.7,zoom)); document.documentElement.style.setProperty('zoom',zoom); zoomLabel.textContent=Math.round(zoom*100)+'%'; localStorage.setItem('zoom',zoom); }
applyZoom();
if(zoomIn) zoomIn.addEventListener('click',()=>{ zoom+=0.1; applyZoom(); });
zoomOut.addEventListener('click',()=>{ zoom-=0.1; applyZoom(); });

// fetch admin config from Firestore
async function loadAdminConfig(){ try{ const snap = await getDoc(doc(db,'config','admin')); if(snap.exists()){ const d = snap.data(); CONFIG_ADMIN.password = d.password; CONFIG_ADMIN.maxGroups = d.maxGroups||3; CONFIG_ADMIN.defaultGroup = d.defaultGroup||'general'; } }catch(e){ console.error('config load',e); } }
loadAdminConfig();

// ---------- AUTH (redirect-based for mobile compatibility) ----------
signInBtn.addEventListener('click', async ()=>{ try{ await signInWithRedirect(auth, provider); }catch(e){ console.error(e); toast('Sign-in error'); } });

// finish redirect flow (if any)
getRedirectResult(auth).then(async (res)=>{
  if(res && res.user){ /* no-op, onAuthStateChanged will handle UI */ }
}).catch(e=>{ console.error('redirect result',e); });

signOutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error(e); } });

onAuthStateChanged(auth, async user=>{
  if(user){ me = { uid:user.uid, name:user.displayName, email:user.email, photo:user.photoURL }; signInBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden'); meName.textContent = me.name || me.email; subtitle.textContent = `Signed in as ${me.name||me.email}`; try{ await setDoc(doc(db,'users',me.uid),{ name: me.name, email: me.email, photo: me.photo },{ merge:true }); }catch{} await ensureDefaultGroup(); await loadGroups(); const adm = await checkIsAdmin(me.uid); if(adm) setAdminMode(true); } else { me=null; signInBtn.classList.remove('hidden'); signOutBtn.classList.add('hidden'); meName.textContent='Not signed'; subtitle.textContent='Sign in with Google'; clearUI(); } });

function clearUI(){ groupsList.innerHTML=''; msgList.innerHTML=''; chatCard.classList.add('hidden'); adminPanel.classList.add('hidden'); adminPanelBtn.classList.add('hidden'); }

// ---------- Ensure default general group ----------
async function ensureDefaultGroup(){ try{ const gRef=doc(db,'groups',CONFIG_ADMIN.defaultGroup||'general'); const gSnap = await getDoc(gRef); if(!gSnap.exists()){ await setDoc(gRef,{ id: CONFIG_ADMIN.defaultGroup||'general', name:'General', public:true, ownerUid:null, created: serverTimestamp() }); } }catch(e){ console.error('ensure default',e); } }

// ---------- Load groups list ----------
async function loadGroups(){
  groupsList.innerHTML='';
  try{
    const snaps = await getDocs(collection(db,'groups'));
    const arr = [];
    snaps.forEach(s=> arr.push(s.data()));
    arr.sort((a,b)=> (a.id===CONFIG_ADMIN.defaultGroup? -1 : (b.id===CONFIG_ADMIN.defaultGroup? 1:0)));
    arr.forEach(g=> renderGroupItem(g));
  }catch(e){ console.error('loadGroups',e); }
}

function renderGroupItem(g){ const el=document.createElement('div'); el.className='group'; el.innerHTML = `<div><div style='font-weight:700'>${escapeHtml(g.name||g.id)}</div><div class='small'>${g.public? 'Public' : 'Private'}</div></div>`; el.addEventListener('click', ()=> openGroup(g.id)); groupsList.appendChild(el); }

// ---------- Open group (membership checks) ----------
async function openGroup(id){ try{ const gSnap = await getDoc(doc(db,'groups',id)); if(!gSnap.exists()){ toast('Group missing'); return; } const g = gSnap.data(); if(!g.public){ const members = g.members||{}; if(!me) { toast('Sign in to join'); return; } if(!(members[me.uid] || g.ownerUid===me.uid)) { toast('Private: you are not a member'); return; } } currentGroup = g; roomTitle.textContent = g.name; roomSubtitle.textContent = g.public? 'Public group' : 'Private group'; chatCard.classList.remove('hidden'); if(messagesUnsub) messagesUnsub(); const q = query(collection(db,'groups',id,'messages'), orderBy('ts')); messagesUnsub = onSnapshot(q,snap=>{ msgList.innerHTML=''; snap.forEach(d=> renderMessage(d.id,d.data())); msgList.scrollTop = msgList.scrollHeight; }); const adm = await checkIsAdmin(me?.uid); if(adm) adminPanelBtn.classList.remove('hidden'); else adminPanelBtn.classList.add('hidden'); }catch(e){ console.error('openGroup',e); } }

// ---------- Render message ----------
function renderMessage(id,m){ try{ const el=document.createElement('div'); el.className='bubble'; if(me && m.uid===me.uid) el.classList.add('mine'); const when = m.ts && m.ts.toDate ? m.ts.toDate().toLocaleTimeString() : ''; el.innerHTML = `<div style='font-weight:700'>${escapeHtml(m.name||m.email||'unknown')}</div><div class='small'>${escapeHtml(when)}</div><div style='margin-top:6px'>${escapeHtml(m.text)}</div>`; // admin tools
  if(isAdmin){ const tools=document.createElement('div'); tools.style.marginTop='6px'; tools.style.display='flex'; tools.style.gap='6px'; const edit=document.createElement('button'); edit.className='menuBtn'; edit.textContent='âœï¸'; edit.onclick=async (ev)=>{ ev.stopPropagation(); const nt = prompt('Edit message', m.text); if(nt!==null){ try{ await updateDoc(doc(db,'groups',currentGroup.id,'messages',id),{ text: nt, edited: true }); toast('Edited'); }catch(e){console.error(e); toast('Edit failed');} }}; const del=document.createElement('button'); del.className='menuBtn'; del.textContent='ðŸ—‘ï¸'; del.onclick=async (ev)=>{ ev.stopPropagation(); if(confirm('Delete this message?')){ try{ await deleteDoc(doc(db,'groups',currentGroup.id,'messages',id)); toast('Deleted'); }catch(e){console.error(e); toast('Delete failed'); } }}; tools.appendChild(edit); tools.appendChild(del); el.appendChild(tools); } msgList.appendChild(el);}catch(e){console.error('renderMessage',e);} }

// ---------- Send message ----------
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
async function sendMessage(){ try{ if(!me) return toast('Sign in first'); if(!currentGroup) return toast('Open a group'); // ban check
  const banSnap = await getDoc(doc(db,'banned',me.uid)); if(banSnap.exists()) return toast('You are banned'); // membership check for private
  if(!currentGroup.public){ const members = currentGroup.members||{}; if(!(members[me.uid]|| currentGroup.ownerUid===me.uid)) return toast('Not a member'); }
  const text = (msgInput.value||'').trim(); if(!text) return; msgInput.value=''; await addDoc(collection(db,'groups',currentGroup.id,'messages'),{ uid: me.uid, name: me.name, email: me.email, text, ts: serverTimestamp() }); }catch(e){ console.error('send',e); toast('Send failed'); } }

// ---------- Admin flows ----------
async function checkIsAdmin(uid){ if(!uid) return false; try{ const snap = await getDoc(doc(db,'admins',uid)); return snap.exists(); }catch(e){ console.error('checkIsAdmin',e); return false; } }

adminPanelBtn.addEventListener('click', async ()=>{ // ask password flow
  if(!me) return toast('Sign in first'); const wants = confirm('Admin login â€” enter password to become admin. Continue?'); if(!wants) return; const pass = prompt('Admin password'); if(pass===null) return; try{ const cfg = await getDoc(doc(db,'config','admin')); if(!cfg.exists()){ toast('Admin config missing'); return; } const real = cfg.data().password; if(String(pass) === String(real)){ await setDoc(doc(db,'admins',me.uid),{ email: me.email, name: me.name, addedAt: serverTimestamp() }); setAdminMode(true); toast('Admin enabled'); } else { toast('Wrong password'); } }catch(e){ console.error('admin flow',e); toast('Admin check failed'); } });

function setAdminMode(on){ isAdmin = !!on; if(isAdmin){ adminPanel.classList.remove('hidden'); adminPanelBtn.classList.add('hidden'); loadAdminsList(); } else { adminPanel.classList.add('hidden'); adminPanelBtn.classList.remove('hidden'); } }

async function loadAdminsList(){ try{ adminsList.innerHTML=''; const snaps = await getDocs(collection(db,'admins')); snaps.forEach(s=>{ const d=s.data(); const el=document.createElement('div'); el.textContent = d.name || d.email || s.id; adminsList.appendChild(el); }); }catch(e){ console.error(e); } }

// create group (admin only)
doCreateGroup.addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admins only'); const name = (newGroupName.value||'').trim(); if(!name) return toast('Enter group name'); try{ // count how many groups this admin owns
    const snaps = await getDocs(collection(db,'groups')); let myCount=0; snaps.forEach(s=>{ const g=s.data(); if(g.ownerUid===me.uid) myCount++; }); const cfgSnap = await getDoc(doc(db,'config','admin')); const maxG = cfgSnap.exists()? (cfgSnap.data().maxGroups||3) : 3; if(myCount>=maxG) return toast('You already created max groups'); // slug id
    const id = name.toLowerCase().replace(/[^a-z0-9-_]/g,'-').slice(0,28) + '_' + (Date.now().toString(36).slice(-5)); await setDoc(doc(db,'groups',id),{ id, name, public:false, ownerUid: me.uid, ownerName: me.name, created: serverTimestamp(), members: {} }); toast('Group created'); newGroupName.value=''; loadGroups(); }catch(e){ console.error('create group',e); toast('Create failed'); } });

// add member by email
addMemberBtn.addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admins only'); if(!currentGroup) return toast('Open a group'); const email = (memberEmail.value||'').trim().toLowerCase(); if(!email) return toast('Enter email'); try{ const usersSnap = await getDocs(collection(db,'users')); let foundUid=null; usersSnap.forEach(u=>{ const d=u.data(); if((d.email||'').toLowerCase()===email) foundUid = u.id; }); if(!foundUid) return toast('User not found â€” they must sign in once'); await updateDoc(doc(db,'groups',currentGroup.id),{ ['members.'+foundUid]: true }); toast('Added'); memberEmail.value=''; }catch(e){ console.error('add member',e); toast('Add failed'); } });

// ban user
banBtn.addEventListener('click', async ()=>{ if(!isAdmin) return toast('Admins only'); const em = prompt('Enter email to ban'); if(!em) return; try{ const usersSnap = await getDocs(collection(db,'users')); let foundUid=null; usersSnap.forEach(u=>{ const d=u.data(); if((d.email||'').toLowerCase()===em.toLowerCase()) foundUid = u.id; }); if(!foundUid) return toast('User not found'); await setDoc(doc(db,'banned',foundUid),{ email: em, by: me.email, at: serverTimestamp() }); toast('User banned'); }catch(e){ console.error('ban',e); toast('Ban failed'); } });

// clear group messages
clearGroupBtn.addEventListener('click', async ()=>{ if(!isAdmin) return toast('Admins only'); if(!currentGroup) return toast('Open a group'); if(!confirm('Delete all messages in this group?')) return; try{ const msgsSnap = await getDocs(collection(db,'groups',currentGroup.id,'messages')); const ops=[]; msgsSnap.forEach(m=> ops.push(deleteDoc(doc(db,'groups',currentGroup.id,'messages',m.id)))); await Promise.all(ops); toast('Cleared'); }catch(e){ console.error('clear',e); toast('Clear failed'); } });

// leave group (for UI only)
leaveBtn.addEventListener('click', ()=>{ currentGroup = null; chatCard.classList.add('hidden'); });

// initial ensure and load
(async ()=>{ try{ await loadAdminConfig(); await ensureDefaultGroup(); await loadGroups(); }catch(e){ console.error('init',e); } })();

</script>
</body>
</html>