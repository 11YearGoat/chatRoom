<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ðŸ’€ Religious & Spiritual Talking â€” Friends</title>
<meta name="theme-color" content="#000" />
<style>
:root{--bg:#050506;--card:#0f1112;--muted:#9aa0a6;--ink:#e6eef2;--line:#1f2326;--accent:#7dd3fc;--accent2:#a78bfa}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#000);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.app{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
.top{display:flex;align-items:center;gap:12px;padding:12px}
.logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041017;font-weight:900}
.title{font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}
.container{flex:1;padding:10px;display:flex;flex-direction:column;gap:10px}
.card{background:var(--card);border-radius:14px;padding:10px;border:1px solid var(--line);display:flex;flex-direction:column;gap:8px}
.groups{display:flex;flex-direction:column;gap:8px;overflow:auto}
.group{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer}
.row{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#041017;padding:8px 10px;border-radius:10px;cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.chatShell{display:flex;flex-direction:column;height:62vh;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
.chatHeader{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--line)}
.msgList{flex:1;padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.bubble{max-width:78%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--line)}
.mine{margin-left:auto;background:linear-gradient(180deg,#0b1220,#0f1b2a)}
.msgMeta{font-size:11px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center}
.chatFooter{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--ink);outline:none}
.hidden{display:none}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:#0b1220;color:#fff;padding:8px 12px;border-radius:10px;z-index:999}
.adminBox{padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--line)}
@media (max-width:420px){ .app{padding:6px} .chatShell{height:58vh} }
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="top">
      <div class="logo">ðŸ’¬</div>
      <div style="flex:1">
        <div class="title">Religious & Spiritual Talking</div>
        <div class="subtitle" id="subtitle">Friends-only chat â€¢ mobile-focused</div>
      </div>
      <div id="authArea" class="row">
        <button id="signInBtn" class="btn">Sign in with Google</button>
        <button id="signOutBtn" class="btn hidden">Sign out</button>
      </div>
    </div>

    <div class="container">
      <!-- Home: groups list -->
      <div id="home" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Groups</div>
            <div class="small">General is public â€” everyone can send</div>
          </div>
          <div class="row">
            <button id="zoomOut" class="small">âˆ’</button>
            <div id="zoomLabel" class="small">100%</div>
            <button id="zoomIn" class="small">ï¼‹</button>
          </div>
        </div>

        <div id="groupsList" class="groups" style="margin-top:8px"></div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button id="createGroupBtn" class="btn">+ Create group</button>
          <button id="adminPanelBtn" class="btn hidden">Admin</button>
        </div>

        <div id="createNote" class="small">Admins can create up to 3 groups (private). Use admin button to manage members.</div>
      </div>

      <!-- Chat shell -->
      <div id="chatCard" class="chatShell hidden">
        <div class="chatHeader">
          <div>
            <div id="roomTitle" style="font-weight:800">Group</div>
            <div class="small" id="roomSubtitle">Private / Public</div>
          </div>
          <div class="row">
            <div id="meName" class="small">Not signed</div>
            <button id="leaveBtn" class="small">Leave</button>
          </div>
        </div>

        <div id="msgList" class="msgList"></div>

        <div class="chatFooter">
          <input id="msgInput" class="input" placeholder="Type a messageâ€¦" />
          <button id="sendBtn" class="btn">Send</button>
        </div>
      </div>

      <!-- Admin panel modal area -->
      <div id="adminPanel" class="card hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Admin Controls</div>
          <div class="small">You are admin</div>
        </div>

        <div class="adminBox">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="newGroupName" class="input" placeholder="New group name (private)" />
            <button id="doCreateGroup" class="btn">Create</button>
          </div>

          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <input id="memberEmail" class="input" placeholder="Add member by email (to selected group)" />
            <button id="addMemberBtn" class="btn">Add</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="banBtn" class="small">ðŸš« Ban user</button>
            <button id="clearGroupBtn" class="small danger">ðŸ§¹ Clear messages</button>
          </div>

          <div style="margin-top:10px">
            <div class="small">Admins list (manage in console) â€” changes reflect here:</div>
            <div id="adminsList" class="small"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="toastWrap"></div>

<script type="module">
// ========== IMPORT FIREBASE MODULES ===========
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where, limit, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

// ========== CONFIG â€” REPLACE WITH YOUR FIREBASE ========
const firebaseConfig = {
  apiKey: "PASTE_API_KEY",
  authDomain: "PASTE_PROJECT.firebaseapp.com",
  projectId: "PASTE_PROJECT",
  storageBucket: "PASTE_PROJECT.appspot.com",
  messagingSenderId: "PASTE_MSG_ID",
  appId: "PASTE_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// ========== UI REFS ===========
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const subtitle = document.getElementById('subtitle');
const groupsList = document.getElementById('groupsList');
const createGroupBtn = document.getElementById('createGroupBtn');
const adminPanelBtn = document.getElementById('adminPanelBtn');
const chatCard = document.getElementById('chatCard');
const roomTitle = document.getElementById('roomTitle');
const roomSubtitle = document.getElementById('roomSubtitle');
const meName = document.getElementById('meName');
const msgList = document.getElementById('msgList');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const leaveBtn = document.getElementById('leaveBtn');
const adminPanel = document.getElementById('adminPanel');
const doCreateGroup = document.getElementById('doCreateGroup');
const newGroupName = document.getElementById('newGroupName');
const addMemberBtn = document.getElementById('addMemberBtn');
const memberEmail = document.getElementById('memberEmail');
const adminsList = document.getElementById('adminsList');
const banBtn = document.getElementById('banBtn');
const clearGroupBtn = document.getElementById('clearGroupBtn');
const zoomIn = document.getElementById('zoomIn')||document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomLabel = document.getElementById('zoomLabel');
const createNote = document.getElementById('createNote');
const createGroupBtnLocal = document.getElementById('createGroupBtn');

// state
let me = null; // {uid,name,email,photo}
let currentGroup = null; // {id,name,public,ownerUid,members:...}
let messagesUnsub = null;
let isAdmin = false;
let zoom = Number(localStorage.getItem('zoom')||1);

// helpers
function toast(t){ const el=document.createElement('div'); el.className='toast'; el.textContent=t; document.body.appendChild(el); setTimeout(()=>el.style.opacity='0',2200); setTimeout(()=>el.remove(),2600); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function applyZoom(){ zoom=Math.min(1.6,Math.max(0.7,zoom)); document.documentElement.style.setProperty('zoom',zoom); zoomLabel.textContent=Math.round(zoom*100)+'%'; localStorage.setItem('zoom',zoom); }
applyZoom();
zoomIn?.addEventListener('click',()=>{ zoom+=0.1; applyZoom(); });
zoomOut.addEventListener('click',()=>{ zoom-=0.1; applyZoom(); });

// ========== AUTH ===========
signInBtn.addEventListener('click', async ()=>{
  try{ await signInWithPopup(auth, provider); }catch(e){ console.error(e); toast('Sign-in failed'); }
});
signOutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch{} });

onAuthStateChanged(auth, async user =>{
  if(user){
    me = { uid: user.uid, name: user.displayName, email: user.email, photo: user.photoURL };
    signInBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden');
    meName.textContent = me.name || me.email;
    subtitle.textContent = `Signed in as ${me.name}`;

    // ensure default general group exists
    await ensureGeneral();

    // load groups and admin status
    await loadGroups();

    // check if user is admin by checking admins collection OR if they know admin password
    const adm = await checkIsAdmin(me.uid);
    if(adm){ setAdminMode(true); }

  } else {
    me = null; signInBtn.classList.remove('hidden'); signOutBtn.classList.add('hidden'); meName.textContent='Not signed'; subtitle.textContent='Sign in with Google'; clearUI(); }
});

function clearUI(){ groupsList.innerHTML=''; msgList.innerHTML=''; chatCard.classList.add('hidden'); adminPanel.classList.add('hidden'); adminPanelBtn.classList.add('hidden'); }

// ========== FIRESTORE HELPERS ===========
async function ensureGeneral(){
  const docRef = doc(db,'groups','general');
  const snap = await getDoc(docRef);
  if(!snap.exists()){
    await setDoc(docRef,{ id:'general', name:'General', public:true, ownerUid:null, created: Date.now() });
  }
}

async function loadGroups(){
  groupsList.innerHTML='';
  const snaps = await getDocs(collection(db,'groups'));
  const arr = [];
  snaps.forEach(s=> arr.push(s.data()));
  // ensure general first
  arr.sort((a,b)=> (a.id==='general'? -1:0));
  arr.forEach(g=> renderGroupItem(g));
}

function renderGroupItem(g){
  const el = document.createElement('div'); el.className='group'; el.innerHTML = `<div><div style='font-weight:700'>${escapeHtml(g.name)}</div><div class='small'>${g.public? 'Public' : 'Private'}</div></div>`;
  el.addEventListener('click', ()=> openGroup(g.id));
  groupsList.appendChild(el);
}

// ========== OPEN GROUP ===========
async function openGroup(id){
  // fetch group
  const gSnap = await getDoc(doc(db,'groups',id));
  if(!gSnap.exists()){ toast('Group missing'); return; }
  const g = gSnap.data();

  // membership check for private groups
  if(!g.public){
    const members = g.members||{};
    if(!me){ toast('Sign in first'); return; }
    if(!(members[me.uid] || g.ownerUid===me.uid || (g.admins && g.admins[me.uid]))){ toast('Private group â€” you are not a member'); return; }
  }

  currentGroup = g; roomTitle.textContent = g.name; roomSubtitle.textContent = g.public? 'Public group' : 'Private group';
  chatCard.classList.remove('hidden');

  // attach messages listener
  if(messagesUnsub) messagesUnsub();
  const q = query(collection(db,'groups',id,'messages'), orderBy('ts'));
  messagesUnsub = onSnapshot(q, snap=>{
    msgList.innerHTML='';
    snap.forEach(d=>{
      const m = d.data(); renderMessage(d.id,m);
    });
    msgList.scrollTop = msgList.scrollHeight;
  });

  // show admin panel button if admin
  const adm = await checkIsAdmin(me?.uid);
  if(adm) adminPanelBtn.classList.remove('hidden'); else adminPanelBtn.classList.add('hidden');
}

// render single message
function renderMessage(id,m){
  if(!m) return;
  const el = document.createElement('div'); el.className='bubble'; if(me && m.uid===me.uid) el.classList.add('mine');
  const ts = m.ts ? new Date(m.ts).toLocaleTimeString() : '';
  el.innerHTML = `<div style='font-weight:700'>${escapeHtml(m.name||m.email||'unknown')}</div><div class='small'>${ts}</div><div style='margin-top:6px'>${escapeHtml(m.text)}</div>`;

  // admin tools on each message
  isAdminCheck().then(admin=>{
    if(admin){
      const tools = document.createElement('div'); tools.style.marginTop='6px'; tools.style.display='flex'; tools.style.gap='6px';
      const edit = document.createElement('button'); edit.className='small'; edit.textContent='âœï¸'; edit.onclick=async (ev)=>{ ev.stopPropagation(); const nt = prompt('Edit message', m.text); if(nt!==null){ await updateDoc(doc(db,'groups',currentGroup.id,'messages',id),{ text: nt, edited: true }); toast('Edited'); }};
      const del = document.createElement('button'); del.className='small'; del.textContent='ðŸ—‘ï¸'; del.onclick=async (ev)=>{ ev.stopPropagation(); if(confirm('Delete this message?')){ await deleteDoc(doc(db,'groups',currentGroup.id,'messages',id)); toast('Deleted'); }};
      tools.appendChild(edit); tools.appendChild(del); el.appendChild(tools);
    }
  });

  msgList.appendChild(el);
}

// ========== SENDING MESSAGES ===========
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
async function sendMessage(){
  if(!me) return toast('Sign in first');
  if(!currentGroup) return toast('Open a group');
  // membership check for private
  if(!currentGroup.public){ const members = currentGroup.members||{}; if(!(members[me.uid]|| currentGroup.ownerUid===me.uid || (currentGroup.admins && currentGroup.admins[me.uid]))){ return toast('You are not a member'); }}
  const text = (msgInput.value||'').trim(); if(!text) return; msgInput.value='';
  await addDoc(collection(db,'groups',currentGroup.id,'messages'),{ uid: me.uid, name: me.name, email: me.email, text, ts: Date.now() });
}

// ========== ADMIN CHECKS and FLOW ===========
// Two-step: first check admins collection; if not present, ask password via Firestore config/admin
async function checkIsAdmin(uid){
  if(!uid) return false;
  // check admins collection
  const aSnap = await getDoc(doc(db,'admins',uid));
  if(aSnap.exists()) return true;
  return false;
}

async function isAdminCheck(){ return isAdmin; }

// Allow user to enter admin password once to become admin (password stored in config/admin.password)
adminPanelBtn.addEventListener('click', async ()=>{
  // ask if admin
  const wants = confirm('Are you an admin? (enter password to become admin)');
  if(!wants) return;
  const pass = prompt('Admin password:'); if(pass===null) return;
  try{
    const cfg = await getDoc(doc(db,'config','admin'));
    if(!cfg.exists()){ toast('Admin config missing'); return; }
    const real = cfg.data().password;
    if(pass === real){
      // set admins/<uid> = true
      await setDoc(doc(db,'admins',me.uid),{ email: me.email, name: me.name, addedAt: Date.now() });
      setAdminMode(true);
      toast('Admin enabled');
    } else { toast('Wrong password'); }
  }catch(e){ console.error(e); toast('Admin check failed'); }
});

function setAdminMode(on){ isAdmin = !!on; if(isAdmin){ adminPanel.classList.remove('hidden'); adminPanelBtn.classList.add('hidden'); loadAdminsList(); } else { adminPanel.classList.add('hidden'); adminPanelBtn.classList.remove('hidden'); } }

async function loadAdminsList(){ adminsList.innerHTML=''; const snaps = await getDocs(collection(db,'admins')); snaps.forEach(s=>{ const d=s.data(); const el=document.createElement('div'); el.textContent = d.name || d.email || s.id; adminsList.appendChild(el); }); }

// ========== CREATE GROUP (Admin only) ===========
doCreateGroup.addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admins only');
  const name = (newGroupName.value||'').trim(); if(!name) return toast('Enter group name');
  // enforce max 3 groups total or per admin? requirement: admins can create 3 groups at most â€” we'll enforce per admin (count groups where ownerUid==me.uid)
  const snaps = await getDocs(collection(db,'groups'));
  const myGroups = [];
  snaps.forEach(s=>{ const g=s.data(); if(g.ownerUid===me.uid) myGroups.push(g); });
  if(myGroups.length >= 3) return toast('You already created 3 groups');
  // create group id slug
  const id = name.toLowerCase().replace(/[^a-z0-9_-]/g,'-').slice(0,28)+'_'+(Date.now().toString(36).slice(-5));
  await setDoc(doc(db,'groups',id),{ id, name, public:false, ownerUid: me.uid, ownerName: me.name, created: Date.now(), members: {} });
  toast('Group created'); newGroupName.value=''; loadGroups();
});

// ========== ADD MEMBER (Admin) ===========
addMemberBtn.addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admins only');
  if(!currentGroup) return toast('Open a group');
  const email = (memberEmail.value||'').trim().toLowerCase(); if(!email) return toast('Enter email');
  // find uid by email from users collection
  const usersSnap = await getDocs(collection(db,'users'));
  let foundUid = null;
  usersSnap.forEach(u=>{ const d=u.data(); if((d.email||'').toLowerCase()===email){ foundUid = u.id; }});
  if(!foundUid) return toast('User not found â€” they must sign in once');
  // set membership
  await updateDoc(doc(db,'groups',currentGroup.id),{ ['members.'+foundUid]: true });
  toast('Added'); memberEmail.value='';
});

// ========== BAN & CLEAR ===========
banBtn.addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admins only');
  const em = prompt('Enter email to ban (user will be blocked from sending)'); if(!em) return;
  // find uid
  const usersSnap = await getDocs(collection(db,'users'));
  let foundUid = null; usersSnap.forEach(u=>{ const d=u.data(); if((d.email||'').toLowerCase()===em.toLowerCase()) foundUid=u.id; });
  if(!foundUid) return toast('User not found');
  await setDoc(doc(db,'banned',foundUid),{ email: em, by: me.email, at: Date.now() });
  toast('User banned');
});

clearGroupBtn.addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admins only');
  if(!currentGroup) return toast('Open a group');
  if(!confirm('Delete all messages in this group?')) return;
  // fetch messages then delete
  const msgsSnap = await getDocs(collection(db,'groups',currentGroup.id,'messages'));
  const delOps = [];
  msgsSnap.forEach(m=>{ delOps.push(deleteDoc(doc(db,'groups',currentGroup.id,'messages',m.id))); });
  await Promise.all(delOps);
  toast('Cleared');
});

// ========== USER PROFILE WRITE (first sign-in) ===========
onAuthStateChanged(auth, async user=>{
  if(user){
    // ensure user profile recorded
    try{ await setDoc(doc(db,'users',user.uid),{ name: user.displayName, email: user.email, photo: user.photoURL },{ merge:true }); }catch(e){}
  }
});

// ========== UTIL: getDoc, getDocs, deleteDoc etc imported above ===========
// ... already used above

// ========== INITIAL: load groups if signed-in state already present ========
(async ()=>{ try{ await ensureGeneral(); await loadGroups(); }catch(e){} })();

</script>
</body>
</html>