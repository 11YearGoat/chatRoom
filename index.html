<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#ff6b9d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Chat-APP">
<title>Chat-APP Pro</title>

<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hhdC1BUFAiLCJzaG9ydF9uYW1lIjoiQ2hhdCIsImRlc2NyaXB0aW9uIjoiUmVhbC10aW1lIGNoYXQgYXBwIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmVmM2Y4IiwidGhlbWVfY29sb3IiOiIjZmY2YjlkIiwib3JpZW50YXRpb24iOiJwb3J0cmFpdCIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzZmY2YjlkJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPSc5MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zNWVtJyBmaWxsPSd3aGl0ZSclM0UlRjAlOUYlOTIlQUMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMiclM0UlM0NyZWN0IHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyBmaWxsPSclMjNmZjZiOWQnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzI0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zNWVtJyBmaWxsPSd3aGl0ZSclM0UlRjAlOUYlOTIlQUMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.8.2.7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{--bg1:#fef3f8;--bg2:#fff;--bg3:#ffe8f3;--tx1:#2d1b3d;--tx2:#7d5a8f;--tx3:#b399c2;--ac1:#ff6b9d;--ac2:#c44569;--bdr:#ffd1e3}
body[data-accent=pink]{--ac1:#ff6b9d;--ac2:#c44569}
body[data-accent=purple]{--ac1:#a855f7;--ac2:#7c3aed}
body[data-accent=blue]{--ac1:#3b82f6;--ac2:#2563eb}
body[data-accent=green]{--ac1:#10b981;--ac2:#059669}
body[data-accent=orange]{--ac1:#f97316;--ac2:#ea580c}
body[data-accent=red]{--ac1:#ef4444;--ac2:#dc2626}
body[data-accent=cyan]{--ac1:#06b6d4;--ac2:#0891b2}
body[data-accent=indigo]{--ac1:#6366f1;--ac2:#4f46e5}
body.dark{--bg1:#1a0d2e;--bg2:#2d1b3d;--bg3:#3d2651;--tx1:#fef3f8;--tx2:#d4a5c9;--tx3:#9d7ba8;--bdr:#4a3258}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:Poppins,sans-serif;background:var(--bg1);color:var(--tx1);height:100vh;overflow:hidden;position:fixed;width:100%;transition:all .3s ease}
.hide{display:none!important}
#login{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#ff6b9d,#c44569,#8e44ad);padding:24px}
.login-card{background:var(--bg2);padding:48px 40px;border-radius:28px;box-shadow:0 10px 30px rgba(0,0,0,.3);text-align:center;max-width:420px;width:100%}
.app-icon{width:88px;height:88px;background:linear-gradient(135deg,#ff6b9d,#c44569);border-radius:22px;margin:0 auto 24px;display:flex;align-items:center;justify-content:center;font-size:50px;box-shadow:0 8px 20px rgba(196,69,105,.4)}
.login-title{font-size:34px;font-weight:700;background:linear-gradient(135deg,#ff6b9d,#c44569);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
.login-subtitle{color:var(--tx2);margin-bottom:32px;font-size:15px}
.user-btn{width:100%;padding:18px;margin:12px 0;border:0;border-radius:18px;background:linear-gradient(135deg,#ff6b9d,#c44569);color:#fff;font-size:17px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:14px;box-shadow:0 6px 16px rgba(255,107,157,.4);transition:transform .2s}
.user-btn:active{transform:scale(.96)}
.user-avatar{width:38px;height:38px;background:rgba(255,255,255,.28);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
.pwa-install{position:fixed;bottom:24px;right:24px;width:64px;height:64px;background:linear-gradient(135deg,#ff6b9d,#c44569);border:0;border-radius:50%;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 6px 24px rgba(255,107,157,.5);display:none;z-index:9999;transition:all .2s;align-items:center;justify-content:center}
.pwa-install:active{transform:scale(.92)}
.pwa-install.show{display:flex;animation:bounce 2s infinite}
@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-12px)}60%{transform:translateY(-6px)}}
#chat{position:fixed;inset:0;background:var(--bg1);padding:12px}
.chat-container{height:100%;max-width:720px;margin:0 auto;background:var(--bg2);border:2px solid var(--bdr);border-radius:24px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 30px rgba(255,107,157,.2)}
.header{background:linear-gradient(135deg,var(--ac1),var(--ac2));padding:18px 20px;display:flex;align-items:center;gap:14px;color:#fff}
.header-avatar{width:46px;height:46px;background:rgba(255,255,255,.28);border:2px solid rgba(255,255,255,.5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
.header-info{flex:1}
.header-title{font-weight:700;font-size:18px}
.header-status{font-size:13px;opacity:.92;margin-top:2px}
.header-btn{width:42px;height:42px;border:0;background:rgba(255,255,255,.22);color:#fff;border-radius:11px;font-size:19px;cursor:pointer;transition:transform .2s}
.header-btn:active{transform:scale(.92)}
.messages{flex:1;overflow-y:auto;padding:20px;background:var(--bg1);display:flex;flex-direction:column;gap:13px}
.messages::-webkit-scrollbar{width:6px}
.messages::-webkit-scrollbar-thumb{background:var(--ac1);border-radius:3px}
.date-divider{display:flex;justify-content:center;margin:18px 0}
.date-label{background:var(--bg3);border:1px solid var(--bdr);padding:5px 13px;border-radius:12px;font-size:12px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.5px}
.msg{max-width:76%;animation:pop .3s ease}
@keyframes pop{0%{opacity:0;transform:scale(.85) translateY(15px)}100%{opacity:1;transform:scale(1) translateY(0)}}
.me{align-self:flex-end}
.you{align-self:flex-start}
.bubble{padding:13px 17px;border-radius:17px;font-size:15px;line-height:1.55;white-space:pre-wrap;word-wrap:break-word;font-weight:500;cursor:pointer;transition:transform .1s;position:relative}
.bubble:active{transform:scale(.98)}
.me .bubble{background:linear-gradient(135deg,var(--ac1),var(--ac2));color:#fff;border-bottom-right-radius:5px;box-shadow:0 4px 14px rgba(255,107,157,.38)}
.you .bubble{background:var(--bg2);border:2px solid var(--bdr);color:var(--tx1);border-bottom-left-radius:5px;box-shadow:0 2px 8px rgba(255,107,157,.12)}
.bubble.deleted{background:transparent!important;border:2px dashed var(--ac1)!important;color:var(--tx3)!important;font-style:italic;opacity:.7}
.edit-badge{font-size:11px;opacity:.7;font-style:italic;margin-left:6px}
.msg-time{font-size:11px;margin-top:6px;text-align:right;opacity:.83;display:flex;align-items:center;justify-content:flex-end;gap:4px}
.me .msg-time{color:rgba(255,255,255,.95)}
.you .msg-time{color:var(--tx3)}
.checks{font-size:13px;font-weight:bold;transition:color .2s}
.checks.delivered{color:#999}
.checks.read{color:#4fc3f7}
.reply-preview{background:rgba(0,0,0,.1);border-left:4px solid currentColor;padding:9px 11px;margin-bottom:9px;border-radius:10px;font-size:13px}
.me .reply-preview{background:rgba(255,255,255,.22)}
.reply-name{font-weight:700;margin-bottom:4px}
.reply-text{opacity:.87;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.typing{padding:0 20px;min-height:26px;font-size:13px;color:var(--ac1);font-style:italic;font-weight:600;display:flex;align-items:center}
.typing.active{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.reply-bar{display:none;background:linear-gradient(90deg,var(--ac1),var(--ac2));color:#fff;padding:11px 20px;position:relative;font-size:14px}
.reply-bar.show{display:block}
.reply-bar-name{font-weight:700;margin-bottom:4px}
.reply-bar-text{opacity:.88;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:42px}
.reply-close{position:absolute;right:14px;top:50%;transform:translateY(-50%);width:30px;height:30px;border:0;background:rgba(255,255,255,.22);color:#fff;border-radius:50%;font-size:21px;cursor:pointer;line-height:1}
.input-area{border-top:2px solid var(--bdr);padding:17px 20px;display:flex;gap:11px;align-items:flex-end;background:var(--bg2)}
textarea{flex:1;min-height:49px;max-height:130px;padding:13px 17px;border:2px solid var(--bdr);border-radius:17px;font-family:inherit;font-size:15px;resize:none;background:var(--bg3);color:var(--tx1);font-weight:500;transition:all .2s}
textarea:focus{outline:0;border-color:var(--ac1);background:var(--bg2);box-shadow:0 0 0 4px rgba(255,107,157,.1)}
.send{width:49px;height:49px;border:0;border-radius:50%;background:linear-gradient(135deg,var(--ac1),var(--ac2));color:#fff;font-size:21px;cursor:pointer;box-shadow:0 4px 14px rgba(255,107,157,.42);display:flex;align-items:center;justify-content:center;transition:transform .2s}
.send:active{transform:scale(.88)}
.send:disabled{opacity:.42;cursor:not-allowed}
.voice-btn{width:49px;height:49px;border:0;border-radius:50%;background:linear-gradient(135deg,var(--ac1),var(--ac2));color:#fff;font-size:21px;cursor:pointer;box-shadow:0 4px 14px rgba(255,107,157,.42);display:flex;align-items:center;justify-content:center;transition:all .2s}
.voice-btn:active{transform:scale(.88)}
.voice-btn.recording{background:linear-gradient(135deg,#ef4444,#dc2626);animation:pulse2 1s infinite}
@keyframes pulse2{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.voice-message{display:flex;align-items:center;gap:10px;padding:8px}
.play-btn{width:36px;height:36px;border:0;border-radius:50%;background:rgba(255,255,255,.2);color:currentColor;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s}
.play-btn:active{transform:scale(.9)}
.waveform{flex:1;height:24px;background:repeating-linear-gradient(90deg,rgba(255,255,255,.3) 0px,rgba(255,255,255,.3) 2px,transparent 2px,transparent 6px);border-radius:12px}
.duration{font-size:12px;opacity:.8;font-weight:600}
.menu{position:fixed;background:var(--bg2);border:2px solid var(--bdr);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.25);min-width:170px;display:none;flex-direction:column;z-index:1000;overflow:hidden}
.menu.show{display:flex;animation:menuPop .2s ease}
@keyframes menuPop{0%{opacity:0;transform:scale(.92)}100%{opacity:1;transform:scale(1)}}
.menu button{padding:15px 20px;border:0;background:0;text-align:left;font-size:15px;font-weight:600;cursor:pointer;color:var(--tx1);display:flex;align-items:center;gap:12px;transition:background .2s}
.menu button:active{background:var(--bg3)}
.menu button.danger{color:#ef4444}
.dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:2000;padding:22px;backdrop-filter:blur(5px)}
.dialog-overlay.show{display:flex;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.dialog-card{background:var(--bg2);padding:28px;border-radius:22px;max-width:400px;width:100%;border:2px solid var(--bdr);box-shadow:0 10px 30px rgba(0,0,0,.3);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(25px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.dialog-title{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--ac1),var(--ac2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
.dialog-message{color:var(--tx2);margin-bottom:22px;line-height:1.65;font-size:15px}
.dialog-actions{display:flex;gap:11px;justify-content:flex-end}
.dialog-btn{padding:13px 26px;border:0;border-radius:13px;font-weight:600;cursor:pointer;font-size:15px;transition:transform .2s}
.dialog-btn-cancel{background:var(--bg3);border:2px solid var(--bdr);color:var(--tx1)}
.dialog-btn-primary{background:linear-gradient(135deg,var(--ac1),var(--ac2));color:#fff;box-shadow:0 4px 12px rgba(255,107,157,.35)}
.dialog-btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;box-shadow:0 4px 12px rgba(239,68,68,.35)}
.dialog-btn:active{transform:scale(.94)}
.settings-card{max-height:80vh;overflow-y:auto}
.settings-section{margin-bottom:32px}
.settings-section-title{font-size:13px;font-weight:700;color:var(--ac1);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px}
.setting-option{padding:18px 0;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;gap:16px}
.setting-option:last-child{border-bottom:none}
.setting-label{font-size:16px;color:var(--tx1);font-weight:600}
.setting-desc{font-size:13px;color:var(--tx2);margin-top:5px;font-weight:500}
.toggle{position:relative;width:54px;height:30px;background:var(--bg3);border:2px solid var(--bdr);border-radius:15px;cursor:pointer;transition:all .3s}
.toggle.active{background:linear-gradient(135deg,var(--ac1),var(--ac2));border-color:var(--ac1)}
.toggle-knob{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:all .3s;box-shadow:0 2px 6px rgba(0,0,0,.2)}
.toggle.active .toggle-knob{transform:translateX(24px)}
.color-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px;padding:4px}
.color-option{padding:32px 20px;border-radius:12px;cursor:pointer;text-align:center;border:3px solid transparent;transition:all .2s}
.color-option.selected{border-color:#fff;box-shadow:0 0 0 4px var(--bg2);transform:scale(1.05)}
.color-name{color:#fff;font-weight:700;font-size:15px}
.notification{position:fixed;top:22px;left:50%;transform:translateX(-50%);background:var(--bg2);border:2px solid var(--bdr);padding:13px 26px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);display:none;z-index:3000;font-weight:600;color:var(--tx1);font-size:14px;max-width:90%}
.notification.show{display:block;animation:slideDown .3s ease}
@keyframes slideDown{from{opacity:0;transform:translate(-50%,-25px)}to{opacity:1;transform:translate(-50%,0)}}
@media(max-width:640px){.messages::-webkit-scrollbar{display:none}}
@media(display-mode:standalone){.pwa-install{display:none!important}}
</style>
</head>

<body data-accent="pink">

<div id="login">
  <div class="login-card">
    <div class="app-icon">üí¨</div>
    <h1 class="login-title">Chat-APP Pro</h1>
    <p class="login-subtitle">Choose your account to continue</p>
    <button class="user-btn" data-user="aditya"><div class="user-avatar">A</div>Aditya</button>
    <button class="user-btn" data-user="vishwatej"><div class="user-avatar">V</div>Vishwatej</button>
  </div>
</div>

<div id="chat" class="hide">
  <div class="chat-container">
    <div class="header">
      <div class="header-avatar" id="headerAvatar">C</div>
      <div class="header-info">
        <div class="header-title">Chat Room</div>
        <div class="header-status" id="status">‚óè Connecting...</div>
      </div>
      <button class="header-btn" id="settingsBtn">‚öôÔ∏è</button>
      <button class="header-btn" id="logoutBtn">‚á¶</button>
    </div>
    <div id="messages" class="messages"></div>
    <div id="typing" class="typing"></div>
    <div id="replyBar" class="reply-bar">
      <div class="reply-bar-name" id="replyName">User</div>
      <div class="reply-bar-text" id="replyText">Message</div>
      <button class="reply-close" id="replyClose">√ó</button>
    </div>
    <div id="editBar" class="reply-bar">
      <div class="reply-bar-name" id="editName">Editing message</div>
      <div class="reply-bar-text" id="editText">Message</div>
      <button class="reply-close" id="editClose">√ó</button>
    </div>
    <div class="input-area">
      <button id="voiceBtn" class="voice-btn">üé§</button>
      <textarea id="input" placeholder="Type a message... (Shift+Enter to send)"></textarea>
      <button id="send" class="send" disabled>‚û§</button>
    </div>
  </div>
</div>

<button id="pwaInstall" class="pwa-install">üì±</button>

<div id="menu" class="menu">
  <button id="mReply">üí¨ Reply</button>
  <button id="mEdit">‚úèÔ∏è Edit</button>
  <button id="mDelete" class="danger">üóëÔ∏è Delete</button>
</div>

<div id="deleteDialog" class="dialog-overlay">
  <div class="dialog-card">
    <div class="dialog-title">Delete message?</div>
    <div class="dialog-message">This message will be deleted for everyone in the chat. This action cannot be undone.</div>
    <div class="dialog-actions">
      <button class="dialog-btn dialog-btn-cancel" id="dialogDeleteCancel">Cancel</button>
      <button class="dialog-btn dialog-btn-danger" id="dialogDeleteConfirm">Delete</button>
    </div>
  </div>
</div>

<div id="logoutDialog" class="dialog-overlay">
  <div class="dialog-card">
    <div class="dialog-title">Logout?</div>
    <div class="dialog-message">Are you sure you want to logout?</div>
    <div class="dialog-actions">
      <button class="dialog-btn dialog-btn-cancel" id="dialogLogoutCancel">Cancel</button>
      <button class="dialog-btn dialog-btn-primary" id="dialogLogoutConfirm">Logout</button>
    </div>
  </div>
</div>

<div id="colorDialog" class="dialog-overlay">
  <div class="dialog-card">
    <div class="dialog-title">Choose Accent Color</div>
    <div class="dialog-message">Select your preferred accent color</div>
    <div class="color-grid">
      <div class="color-option selected" data-color="pink" style="background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);"><span class="color-name">Pink</span></div>
      <div class="color-option" data-color="purple" style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);"><span class="color-name">Purple</span></div>
      <div class="color-option" data-color="blue" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"><span class="color-name">Blue</span></div>
      <div class="color-option" data-color="green" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"><span class="color-name">Green</span></div>
      <div class="color-option" data-color="orange" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"><span class="color-name">Orange</span></div>
      <div class="color-option" data-color="red" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"><span class="color-name">Red</span></div>
      <div class="color-option" data-color="cyan" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);"><span class="color-name">Cyan</span></div>
      <div class="color-option" data-color="indigo" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);"><span class="color-name">Indigo</span></div>
    </div>
    <div class="dialog-actions">
      <button class="dialog-btn dialog-btn-cancel" id="dialogColorCancel">Cancel</button>
      <button class="dialog-btn dialog-btn-primary" id="dialogColorApply">Apply</button>
    </div>
  </div>
</div>

<div id="settingsDialog" class="dialog-overlay">
  <div class="dialog-card settings-card">
    <div class="dialog-title">Settings</div>
    <div class="settings-section">
      <div class="settings-section-title">Appearance</div>
      <div class="setting-option">
        <div style="flex: 1;">
          <div class="setting-label">Theme Mode</div>
          <div class="setting-desc">Switch between light and dark mode</div>
        </div>
        <div class="toggle" id="themeToggle">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div class="setting-option">
        <div style="flex: 1;">
          <div class="setting-label">Accent Color</div>
          <div class="setting-desc">Customize app theme color</div>
        </div>
        <button class="dialog-btn dialog-btn-primary" id="openColorDialog" style="min-width: 80px;">Choose</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Notifications</div>
      <div class="setting-option">
        <div>
          <div class="setting-label">Sound</div>
          <div class="setting-desc">Play sound for new messages</div>
        </div>
        <div class="toggle" id="soundToggle">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div class="setting-option">
        <div>
          <div class="setting-label">Notifications</div>
          <div class="setting-desc">Show popup notifications</div>
        </div>
        <div class="toggle active" id="notifToggle">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div class="setting-option">
        <div>
          <div class="setting-label">Push Notifications</div>
          <div class="setting-desc">Get notified when app is closed</div>
        </div>
        <div class="toggle" id="pushToggle">
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Behavior</div>
      <div class="setting-option">
        <div>
          <div class="setting-label">Auto-scroll</div>
          <div class="setting-desc">Scroll to new messages</div>
        </div>
        <div class="toggle active" id="scrollToggle">
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>
    <div class="dialog-actions" style="margin-top: 24px;">
      <button class="dialog-btn dialog-btn-primary" id="dialogSettingsClose" style="width: 100%;">Close</button>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
console.log("üöÄ Chat-APP Pro v2.0 - Loading...");

// SERVICE WORKER FOR PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swCode = `
      const CACHE = 'chat-v2';
      self.addEventListener('install', e => {
        console.log('SW: Installing...');
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/'])));
        self.skipWaiting();
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
      });

      // PUSH NOTIFICATIONS
      self.addEventListener('push', e => {
        console.log('SW: Push received', e.data);
        const data = e.data ? e.data.json() : {};
        const options = {
          body: data.body || 'New message',
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="192" height="192" fill="%23ff6b9d"/><text x="50%" y="50%" font-size="90" text-anchor="middle" dy=".35em" fill="white">üí¨</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><circle cx="48" cy="48" r="48" fill="%23ff6b9d"/></svg>',
          vibrate: [200, 100, 200],
          tag: 'chat-message',
          requireInteraction: false,
          data: data
        };
        e.waitUntil(self.registration.showNotification(data.title || 'Chat-APP', options));
      });

      self.addEventListener('notificationclick', e => {
        console.log('SW: Notification clicked');
        e.notification.close();
        e.waitUntil(clients.openWindow('/'));
      });
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(reg => {
      console.log('‚úÖ Service Worker registered', reg);
    }).catch(err => {
      console.log('‚ùå Service Worker failed', err);
    });
  });
}

// PWA INSTALL
let deferredPrompt = null;
const pwaBtn = document.getElementById('pwaInstall');

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('üéØ PWA prompt available');
  e.preventDefault();
  deferredPrompt = e;
  pwaBtn.classList.add('show');
});

pwaBtn.addEventListener('click', async () => {
  if (!deferredPrompt) {
    notify('‚ö†Ô∏è Use browser menu: Add to Home Screen');
    return;
  }
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  if (result.outcome === 'accepted') {
    notify('‚úÖ App installed!');
  }
  deferredPrompt = null;
  pwaBtn.classList.remove('show');
});

setTimeout(() => {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
  if (!isStandalone && !deferredPrompt) {
    pwaBtn.classList.add('show');
  }
}, 3000);

// REQUEST NOTIFICATION PERMISSION
async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    console.log('‚ùå Notifications not supported');
    return false;
  }

  if (Notification.permission === 'granted') {
    console.log('‚úÖ Notification permission already granted');
    return true;
  }

  if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      console.log('‚úÖ Notification permission granted');
      notify('üîî Notifications enabled!');
      return true;
    }
  }

  console.log('‚ùå Notification permission denied');
  return false;
}

// SHOW DESKTOP NOTIFICATION
function showDesktopNotification(title, body) {
  if (Notification.permission === 'granted') {
    const notification = new Notification(title, {
      body: body,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="192" height="192" fill="%23ff6b9d"/><text x="50%" y="50%" font-size="90" text-anchor="middle" dy=".35em" fill="white">üí¨</text></svg>',
      vibrate: [200, 100, 200],
      tag: 'chat-message'
    });

    notification.onclick = () => {
      window.focus();
      notification.close();
    };
  }
}

// PUBNUB CONFIG
const CONFIG = {
  publishKey: "pub-c-7a616042-44f7-4676-8e55-bcc9c12dc017",
  subscribeKey: "sub-c-96e9508a-dd7c-4241-9648-15195841b3f8",
  uuid: null,
  restore: false,
  heartbeatInterval: 0,
  suppressLeaveEvents: true,
  presenceTimeout: 0
};

const CHANNEL = "chat-room";
const CHANNEL_DELETE = "chat-room-deletes";
const CHANNEL_SIGNALS = "chat-room-signals";
const ALLOWED = ["aditya", "vishwatej"];

const $ = id => document.getElementById(id);
const el = {
  login: $("login"), chat: $("chat"), messages: $("messages"), input: $("input"),
  send: $("send"), typing: $("typing"), replyBar: $("replyBar"), replyName: $("replyName"),
  replyText: $("replyText"), replyClose: $("replyClose"), editBar: $("editBar"),
  editName: $("editName"), editText: $("editText"), editClose: $("editClose"),
  menu: $("menu"), mReply: $("mReply"), mEdit: $("mEdit"), mDelete: $("mDelete"),
  deleteDialog: $("deleteDialog"), dialogDeleteCancel: $("dialogDeleteCancel"),
  dialogDeleteConfirm: $("dialogDeleteConfirm"), notification: $("notification"),
  status: $("status"), headerAvatar: $("headerAvatar"),
  logoutBtn: $("logoutBtn"), settingsBtn: $("settingsBtn"),
  settingsDialog: $("settingsDialog"), dialogSettingsClose: $("dialogSettingsClose"),
  soundToggle: $("soundToggle"), notifToggle: $("notifToggle"),
  pushToggle: $("pushToggle"), scrollToggle: $("scrollToggle"),
  openColorDialog: $("openColorDialog"), colorDialog: $("colorDialog"),
  dialogColorCancel: $("dialogColorCancel"), dialogColorApply: $("dialogColorApply"),
  logoutDialog: $("logoutDialog"), dialogLogoutCancel: $("dialogLogoutCancel"),
  dialogLogoutConfirm: $("dialogLogoutConfirm"), themeToggle: $("themeToggle"),
  voiceBtn: $("voiceBtn")
};

const state = {
  user: null,
  pubnub: null,
  messages: new Map(),
  deletedIds: new Set(),
  replyTo: null,
  editingMessage: null,
  connected: false,
  typingUsers: new Set(),
  typingTimer: null,
  lastTypingSignal: 0,
  recording: false,
  mediaRecorder: null,
  audioChunks: [],
  currentAudio: null,
  settings: {
    sound: false,
    notifications: true,
    pushNotifications: false,
    autoScroll: true,
    accentColor: "pink",
    darkMode: false
  }
};

document.querySelectorAll(".user-btn").forEach(btn => {
  btn.onclick = () => {
    const name = btn.dataset.user;
    if (!ALLOWED.includes(name)) {
      notify("‚ùå Access denied");
      return;
    }
    CONFIG.uuid = name;
    login(name);
  };
});

function login(name) {
  state.user = {
    name: name,
    displayName: name.charAt(0).toUpperCase() + name.slice(1)
  };

  localStorage.setItem("chatUser", JSON.stringify(state.user));
  el.headerAvatar.textContent = state.user.displayName.charAt(0);
  el.login.classList.add("hide");
  el.chat.classList.remove("hide");

  console.log("‚úÖ Logged in as:", state.user.displayName);

  // Request notification permission
  requestNotificationPermission();

  initPubNub();
}

function initPubNub() {
  try {
    console.log("üîß Initializing PubNub...");

    state.pubnub = new PubNub(CONFIG);

    state.pubnub.addListener({
      status: s => {
        console.log("üì° Status:", s.category);

        if (s.category === "PNConnectedCategory") {
          state.connected = true;
          el.status.textContent = "‚óè Online";
          console.log("‚úÖ Connected!");
          notify("‚úÖ Connected!");
          loadHistory();
          loadDeleteHistory();
        } else if (s.category === "PNAccessDeniedCategory") {
          console.error("‚ùå Access denied");
          el.status.textContent = "‚óè Access Denied";
          notify("‚ùå Access denied");
        } else if (s.category === "PNNetworkDownCategory") {
          state.connected = false;
          el.status.textContent = "‚óè Offline";
          notify("‚ö†Ô∏è Network offline");
        }
      },

      message: m => {
        const msg = m.message;
        msg.timetoken = m.timetoken;

        // DELETE CHANNEL
        if (m.channel === CHANNEL_DELETE) {
          console.log("üóëÔ∏è Delete event:", msg.id);
          handleDelete(msg.id);
          return;
        }

        // SIGNALS CHANNEL (TYPING)
        if (m.channel === CHANNEL_SIGNALS) {
          handleSignal(msg);
          return;
        }

        // VOICE MESSAGE
        if (msg.type === "voice") {
          renderMessage(msg, true);
        } else {
          // REGULAR MESSAGE
          renderMessage(msg, true);
        }

        // NOTIFICATIONS
        if (msg.name !== state.user.name) {
          if (state.settings.notifications) {
            const text = msg.type === "voice" ? "üé§ Voice message" : msg.txt;
            notify(msg.displayName + ": " + text.substring(0, 30) + "...");
          }

          // DESKTOP/PUSH NOTIFICATION
          if (state.settings.pushNotifications || document.hidden) {
            const text = msg.type === "voice" ? "Sent a voice message" : msg.txt;
            showDesktopNotification(msg.displayName, text);
          }
        }
      }
    });

    state.pubnub.subscribe({ 
      channels: [CHANNEL, CHANNEL_DELETE, CHANNEL_SIGNALS],
      withPresence: false
    });

    console.log("‚úÖ Subscribed to all channels");

  } catch (error) {
    console.error("‚ùå PubNub init error:", error);
    notify("‚ùå Connection failed");
    el.status.textContent = "‚óè Error";
  }
}

// TYPING INDICATOR
function handleSignal(signal) {
  if (signal.type === "typing" && signal.user !== state.user.name) {
    state.typingUsers.add(signal.displayName);
    updateTypingIndicator();

    setTimeout(() => {
      state.typingUsers.delete(signal.displayName);
      updateTypingIndicator();
    }, 3000);
  }

  if (signal.type === "stopped_typing") {
    state.typingUsers.delete(signal.displayName);
    updateTypingIndicator();
  }
}

function updateTypingIndicator() {
  if (state.typingUsers.size === 0) {
    el.typing.textContent = "";
    el.typing.classList.remove("active");
    return;
  }

  const names = Array.from(state.typingUsers);
  el.typing.classList.add("active");

  if (names.length === 1) {
    el.typing.textContent = `${names[0]} is typing...`;
  } else if (names.length === 2) {
    el.typing.textContent = `${names[0]} and ${names[1]} are typing...`;
  } else {
    el.typing.textContent = `${names.length} people are typing...`;
  }
}

el.input.addEventListener("input", () => {
  el.send.disabled = !el.input.value.trim();
  el.input.style.height = "auto";
  el.input.style.height = Math.min(el.input.scrollHeight, 130) + "px";

  // SEND TYPING SIGNAL
  clearTimeout(state.typingTimer);

  const now = Date.now();
  if (now - state.lastTypingSignal > 2000) {
    state.pubnub.publish({
      channel: CHANNEL_SIGNALS,
      message: {
        type: "typing",
        user: state.user.name,
        displayName: state.user.displayName,
        timestamp: now
      }
    });
    state.lastTypingSignal = now;
  }

  state.typingTimer = setTimeout(() => {
    state.pubnub.publish({
      channel: CHANNEL_SIGNALS,
      message: {
        type: "stopped_typing",
        user: state.user.name
      }
    });
  }, 3000);
});

function loadHistory() {
  state.pubnub.fetchMessages({ 
    channels: [CHANNEL], 
    count: 50
  })
  .then(response => {
    const msgs = (response.channels[CHANNEL] || [])
      .map(e => {
        const msg = e.message;
        msg.timetoken = e.timetoken;
        return msg;
      })
      .filter(m => m && (m.txt || m.type === "voice"));

    console.log("üì• Loaded", msgs.length, "messages");
    msgs.forEach(m => renderMessage(m, false));

    if (state.settings.autoScroll) {
      el.messages.scrollTop = el.messages.scrollHeight;
    }
  })
  .catch(error => {
    console.error("‚ùå History error:", error);
  });
}

function loadDeleteHistory() {
  console.log("üì° Loading delete history...");

  state.pubnub.fetchMessages({ 
    channels: [CHANNEL_DELETE], 
    count: 100
  })
  .then(response => {
    const deletes = (response.channels[CHANNEL_DELETE] || [])
      .map(e => e.message)
      .filter(m => m && m.id);

    console.log("üì• Loaded", deletes.length, "delete events");

    deletes.forEach(d => {
      state.deletedIds.add(d.id);
    });

    deletes.forEach(d => {
      const msg = state.messages.get(d.id);
      if (msg && !msg.deleted) {
        msg.deleted = true;
        const node = el.messages.querySelector(`[data-id="${d.id}"] .bubble`);
        if (node) {
          node.className = "bubble deleted";
          node.innerHTML = "üö´ This message was deleted";
        }
      }
    });

    console.log("‚úÖ Delete history applied");
  })
  .catch(error => {
    console.error("‚ùå Delete history error:", error);
  });
}

function dayLabel(ts) {
  const d = new Date(ts);
  const t = new Date();
  const y = new Date(t);
  y.setDate(t.getDate() - 1);

  if (d.toDateString() === t.toDateString()) return "Today";
  if (d.toDateString() === y.toDateString()) return "Yesterday";

  return d.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: d.getFullYear() !== t.getFullYear() ? "numeric" : undefined
  });
}

function needDivider(curr, prev) {
  if (!prev) return true;
  return new Date(curr).toDateString() !== new Date(prev).toDateString();
}

function insertDivider(ts) {
  const div = document.createElement("div");
  div.className = "date-divider";
  div.innerHTML = `<div class="date-label">${dayLabel(ts)}</div>`;
  el.messages.appendChild(div);
}

function renderMessage(msg, animate) {
  if (!msg || !msg.id) return;
  if (state.messages.has(msg.id)) return;

  const isDeleted = state.deletedIds.has(msg.id);
  if (isDeleted) {
    msg.deleted = true;
  }

  const lastMsg = [...state.messages.values()].pop();
  if (needDivider(msg.ts, lastMsg?.ts)) insertDivider(msg.ts);

  state.messages.set(msg.id, msg);

  const isMe = msg.name === state.user?.name;
  const wrapper = document.createElement("div");
  wrapper.className = `msg ${isMe ? "me" : "you"}`;
  wrapper.dataset.id = msg.id;

  const bubble = document.createElement("div");
  bubble.className = msg.deleted ? "bubble deleted" : "bubble";

  // REPLY PREVIEW
  if (msg.reply && !msg.deleted) {
    const replyDiv = document.createElement("div");
    replyDiv.className = "reply-preview";
    replyDiv.innerHTML = `<div class="reply-name">${msg.reply.displayName}</div><div class="reply-text">${msg.reply.txt}</div>`;
    bubble.appendChild(replyDiv);
  }

  // MESSAGE CONTENT
  if (msg.type === "voice") {
    const voiceDiv = document.createElement("div");
    voiceDiv.className = "voice-message";
    voiceDiv.innerHTML = `
      <button class="play-btn" data-audio="${msg.audioData}">‚ñ∂</button>
      <div class="waveform"></div>
      <span class="duration">${formatDuration(msg.duration)}</span>
    `;
    bubble.appendChild(voiceDiv);

    voiceDiv.querySelector('.play-btn').onclick = (e) => {
      e.stopPropagation();
      playVoiceMessage(msg.audioData, e.target);
    };
  } else {
    const textDiv = document.createElement("div");
    textDiv.textContent = msg.deleted ? "üö´ This message was deleted" : msg.txt;

    if (msg.edited && !msg.deleted) {
      const editBadge = document.createElement("span");
      editBadge.className = "edit-badge";
      editBadge.textContent = "(edited)";
      textDiv.appendChild(editBadge);
    }

    bubble.appendChild(textDiv);
  }

  // TIME + CHECKMARKS
  const timeDiv = document.createElement("div");
  timeDiv.className = "msg-time";
  timeDiv.textContent = new Date(msg.ts).toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit"
  });

  if (isMe && !msg.deleted && msg.type !== "voice") {
    const checks = document.createElement("span");
    checks.className = `checks ${msg.status || 'delivered'}`;
    checks.textContent = msg.status === "read" ? "‚úì‚úì" : "‚úì‚úì";
    timeDiv.appendChild(checks);
  }

  bubble.appendChild(timeDiv);

  wrapper.appendChild(bubble);
  el.messages.appendChild(wrapper);

  if (animate && state.settings.autoScroll) {
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  if (!msg.deleted && msg.type !== "voice") {
    bubble.addEventListener("contextmenu", e => {
      e.preventDefault();
      showMenu(e.clientX, e.clientY, msg, isMe);
    });

    let touchTimer;
    bubble.addEventListener("touchstart", e => {
      touchTimer = setTimeout(() => {
        showMenu(e.touches[0].clientX, e.touches[0].clientY, msg, isMe);
      }, 500);
    });
    bubble.addEventListener("touchend", () => clearTimeout(touchTimer));
  }
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function playVoiceMessage(audioData, button) {
  if (state.currentAudio) {
    state.currentAudio.pause();
    state.currentAudio = null;
  }

  const audio = new Audio(audioData);
  state.currentAudio = audio;

  button.textContent = "‚è∏";
  audio.play();

  audio.onended = () => {
    button.textContent = "‚ñ∂";
    state.currentAudio = null;
  };

  button.onclick = (e) => {
    e.stopPropagation();
    if (audio.paused) {
      audio.play();
      button.textContent = "‚è∏";
    } else {
      audio.pause();
      button.textContent = "‚ñ∂";
    }
  };
}

function showMenu(x, y, msg, isMe) {
  el.menu.style.left = Math.min(x, window.innerWidth - 180) + "px";
  el.menu.style.top = Math.min(y, window.innerHeight - 200) + "px";
  el.menu.classList.add("show");
  el.menu.dataset.msg = JSON.stringify(msg);
  el.mEdit.style.display = isMe ? "flex" : "none";
  el.mDelete.style.display = isMe ? "flex" : "none";
}

document.addEventListener("click", () => el.menu.classList.remove("show"));

el.mReply.onclick = () => {
  const msg = JSON.parse(el.menu.dataset.msg);
  state.replyTo = msg;
  el.replyName.textContent = msg.displayName;
  el.replyText.textContent = msg.txt;
  el.replyBar.classList.add("show");
  el.editBar.classList.remove("show");
  el.input.focus();
};

el.mEdit.onclick = () => {
  const msg = JSON.parse(el.menu.dataset.msg);
  state.editingMessage = msg;
  el.input.value = msg.txt;
  el.editName.textContent = "Editing message";
  el.editText.textContent = msg.txt;
  el.editBar.classList.add("show");
  el.replyBar.classList.remove("show");
  el.input.focus();
};

el.mDelete.onclick = () => {
  const msg = JSON.parse(el.menu.dataset.msg);
  el.deleteDialog.classList.add("show");
  el.deleteDialog.dataset.id = msg.id;
};

el.dialogDeleteCancel.onclick = () => el.deleteDialog.classList.remove("show");

el.dialogDeleteConfirm.onclick = () => {
  const id = el.deleteDialog.dataset.id;

  state.pubnub.publish({
    channel: CHANNEL_DELETE,
    message: { 
      id: id,
      deletedBy: state.user.name,
      deletedAt: Date.now()
    },
    storeInHistory: true
  }).then(() => {
    handleDelete(id);
    el.deleteDialog.classList.remove("show");
    notify("üóëÔ∏è Message deleted");
  }).catch(error => {
    notify("‚ùå Failed to delete");
  });
};

function handleDelete(id) {
  state.deletedIds.add(id);

  const msg = state.messages.get(id);
  if (msg) {
    msg.deleted = true;
  }

  const node = el.messages.querySelector(`[data-id="${id}"] .bubble`);
  if (node) {
    node.className = "bubble deleted";
    node.innerHTML = "üö´ This message was deleted";
  }
}

el.input.addEventListener("keydown", e => {
  if (e.key === "Enter" && e.shiftKey) {
    e.preventDefault();
    send();
  }
});

el.send.onclick = send;

el.replyClose.onclick = () => {
  state.replyTo = null;
  el.replyBar.classList.remove("show");
};

el.editClose.onclick = () => {
  state.editingMessage = null;
  el.editBar.classList.remove("show");
  el.input.value = "";
};

function send() {
  const txt = el.input.value.trim();

  if (!txt || !state.connected) {
    if (!state.connected) notify("‚ùå Not connected");
    return;
  }

  // STOP TYPING SIGNAL
  state.pubnub.publish({
    channel: CHANNEL_SIGNALS,
    message: {
      type: "stopped_typing",
      user: state.user.name
    }
  });
  clearTimeout(state.typingTimer);

  // EDIT MODE
  if (state.editingMessage) {
    state.pubnub.publish({
      channel: CHANNEL_DELETE,
      message: { 
        id: state.editingMessage.id,
        deletedBy: state.user.name,
        deletedAt: Date.now()
      }
    });

    const editedMsg = {
      id: state.editingMessage.id,
      txt: txt,
      ts: Date.now(),
      name: state.user.name,
      displayName: state.user.displayName,
      edited: true,
      originalTs: state.editingMessage.ts,
      status: "sent"
    };

    state.pubnub.publish({
      channel: CHANNEL,
      message: editedMsg
    });

    state.editingMessage = null;
    el.editBar.classList.remove("show");
    el.input.value = "";
    el.input.style.height = "auto";
    el.send.disabled = true;
    return;
  }

  // NORMAL MESSAGE
  const msg = {
    id: Date.now() + "-" + Math.random().toString(36).slice(2, 9),
    txt: txt,
    ts: Date.now(),
    name: state.user.name,
    displayName: state.user.displayName,
    status: "sent"
  };

  if (state.replyTo) {
    msg.reply = {
      id: state.replyTo.id,
      txt: state.replyTo.txt,
      displayName: state.replyTo.displayName
    };
    state.replyTo = null;
    el.replyBar.classList.remove("show");
  }

  el.send.disabled = true;

  state.pubnub.publish({
    channel: CHANNEL,
    message: msg
  })
  .then(() => {
    el.input.value = "";
    el.input.style.height = "auto";
    setTimeout(() => el.send.disabled = !el.input.value.trim(), 100);
  })
  .catch(error => {
    notify("‚ùå Send failed");
    el.send.disabled = false;
  });
}

// VOICE MESSAGES
el.voiceBtn.addEventListener("mousedown", startRecording);
el.voiceBtn.addEventListener("touchstart", startRecording);
el.voiceBtn.addEventListener("mouseup", stopRecording);
el.voiceBtn.addEventListener("touchend", stopRecording);

async function startRecording(e) {
  e.preventDefault();

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    state.mediaRecorder = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'
    });

    state.audioChunks = [];
    state.recordingStart = Date.now();

    state.mediaRecorder.ondataavailable = (e) => {
      state.audioChunks.push(e.data);
    };

    state.mediaRecorder.start();
    state.recording = true;

    el.voiceBtn.classList.add("recording");
    el.voiceBtn.textContent = "üî¥";
    notify("üé§ Recording...");

  } catch (error) {
    notify("‚ùå Microphone access denied");
  }
}

function stopRecording(e) {
  e.preventDefault();

  if (!state.recording) return;

  state.mediaRecorder.stop();
  state.recording = false;

  el.voiceBtn.classList.remove("recording");
  el.voiceBtn.textContent = "üé§";

  state.mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
    const duration = Math.floor((Date.now() - state.recordingStart) / 1000);

    if (audioBlob.size > 5 * 1024 * 1024) {
      notify("‚ùå Voice message too large (max 5MB)");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      sendVoiceMessage(reader.result, duration);
    };
    reader.readAsDataURL(audioBlob);

    state.mediaRecorder.stream.getTracks().forEach(track => track.stop());
  };
}

function sendVoiceMessage(audioData, duration) {
  const msg = {
    id: Date.now() + "-" + Math.random().toString(36).slice(2, 9),
    type: "voice",
    audioData: audioData,
    duration: duration,
    ts: Date.now(),
    name: state.user.name,
    displayName: state.user.displayName
  };

  state.pubnub.publish({
    channel: CHANNEL,
    message: msg
  }).then(() => {
    notify("üé§ Voice message sent");
  }).catch(() => {
    notify("‚ùå Failed to send voice message");
  });
}

// SETTINGS
el.themeToggle.onclick = () => {
  state.settings.darkMode = !state.settings.darkMode;
  el.themeToggle.classList.toggle("active", state.settings.darkMode);
  document.body.classList.toggle("dark", state.settings.darkMode);
  localStorage.setItem("settings", JSON.stringify(state.settings));
  notify(state.settings.darkMode ? "üåô Dark mode" : "‚òÄÔ∏è Light mode");
};

el.logoutBtn.onclick = () => {
  el.logoutDialog.classList.add("show");
};

el.dialogLogoutCancel.onclick = () => {
  el.logoutDialog.classList.remove("show");
};

el.dialogLogoutConfirm.onclick = () => {
  if (state.pubnub) state.pubnub.unsubscribeAll();
  localStorage.removeItem("chatUser");
  location.reload();
};

el.settingsBtn.onclick = () => {
  el.settingsDialog.classList.add("show");
};

el.dialogSettingsClose.onclick = () => {
  el.settingsDialog.classList.remove("show");
};

el.soundToggle.onclick = () => {
  state.settings.sound = !state.settings.sound;
  el.soundToggle.classList.toggle("active", state.settings.sound);
  localStorage.setItem("settings", JSON.stringify(state.settings));
};

el.notifToggle.onclick = () => {
  state.settings.notifications = !state.settings.notifications;
  el.notifToggle.classList.toggle("active", state.settings.notifications);
  localStorage.setItem("settings", JSON.stringify(state.settings));
};

el.pushToggle.onclick = async () => {
  state.settings.pushNotifications = !state.settings.pushNotifications;
  el.pushToggle.classList.toggle("active", state.settings.pushNotifications);

  if (state.settings.pushNotifications) {
    const granted = await requestNotificationPermission();
    if (!granted) {
      state.settings.pushNotifications = false;
      el.pushToggle.classList.remove("active");
      notify("‚ùå Notification permission denied");
    }
  }

  localStorage.setItem("settings", JSON.stringify(state.settings));
};

el.scrollToggle.onclick = () => {
  state.settings.autoScroll = !state.settings.autoScroll;
  el.scrollToggle.classList.toggle("active", state.settings.autoScroll);
  localStorage.setItem("settings", JSON.stringify(state.settings));
};

el.openColorDialog.onclick = () => {
  el.colorDialog.classList.add("show");
};

el.dialogColorCancel.onclick = () => {
  el.colorDialog.classList.remove("show");
};

document.querySelectorAll(".color-option").forEach(opt => {
  opt.onclick = () => {
    document.querySelectorAll(".color-option").forEach(o => o.classList.remove("selected"));
    opt.classList.add("selected");
    state.settings.accentColor = opt.dataset.color;
  };
});

el.dialogColorApply.onclick = () => {
  document.body.dataset.accent = state.settings.accentColor;
  localStorage.setItem("settings", JSON.stringify(state.settings));
  el.colorDialog.classList.remove("show");
  notify("‚úÖ Color changed");
};

function notify(text) {
  el.notification.textContent = text;
  el.notification.classList.add("show");
  setTimeout(() => el.notification.classList.remove("show"), 3000);
}

window.addEventListener("load", () => {
  try {
    const saved = localStorage.getItem("chatUser");
    if (saved) {
      const user = JSON.parse(saved);
      if (ALLOWED.includes(user.name)) {
        CONFIG.uuid = user.name;
        login(user.name);
      }
    }

    const savedSettings = localStorage.getItem("settings");
    if (savedSettings) {
      Object.assign(state.settings, JSON.parse(savedSettings));
      el.soundToggle.classList.toggle("active", state.settings.sound);
      el.notifToggle.classList.toggle("active", state.settings.notifications);
      el.pushToggle.classList.toggle("active", state.settings.pushNotifications);
      el.scrollToggle.classList.toggle("active", state.settings.autoScroll);
      el.themeToggle.classList.toggle("active", state.settings.darkMode);
      document.body.classList.toggle("dark", state.settings.darkMode);
      document.body.dataset.accent = state.settings.accentColor;
    }
  } catch (e) {
    console.error("Restore error:", e);
  }
});

console.log("‚úÖ Chat-APP Pro v2.0 - Ready!");
</script>

</body>
</html>
